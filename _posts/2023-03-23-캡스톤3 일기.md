---
layout: post
category: Note
use_math: true
---

## 4/1 로그인/회원가입 구현

## django-allauth의 /account와 프로젝트 내 /account 충돌

초기 세팅에서 우리는 이미 account app을 생성했다. 하지만, Django-allauth도 내부의 account app이 있어서 usermodel이 충돌했다. 둘 중 하나를 바꿔야 했다.
```python
# setting.py
INSTALLED_APPS = [
    ...
    'account',
    ...

    # For allauth:
    'django.contrib.sites',
    'allauth',
    'allauth.account',
    ...
```

이러면 *Application labels aren’t unique, duplicates: account* 오류가 뜬다. </br>
same label을 사용하고 있어서, accout에 unique한 label을 넣어줘야 한다.
```python
# account/apps.py
from django.apps import AppConfig


# class AccountConfig(AppConfig):
#     default_auto_field = 'django.db.models.BigAutoField'
#     name = 'account'

class AccountConfig(AppConfig):
    name = 'account'
    label = 'local_user'  # Change this
```

다음으로 **setting.py**도 변경해준다.
```python
# setting.py
INSTALLED_APPS = [
    ...
    'account.apps.AccountConfig', #change this from 'account'
    ...
]
```

하단에 usermodel도 변경해준다.
```python
# setting.py
AUTH_USER_MODEL = 'local_user.User'
```

이전의 *account*에서 migrate한 내용을 모두 삭제하고, 다시 migration 해주면 해결.

## 사용자 실시간 위치 계속 받기

```python
import redis
import json
import requests
import time

# Redis 클라이언트 생성
redis_client = redis.Redis(host='localhost', port=6379, db=0)

# Kakao API로부터 사용자의 현재 위치 정보를 가져오는 함수
def get_user_location():
    headers = {
        'Authorization': 'KakaoAK YOUR_APP_KEY'
    }
    response = requests.get('https://dapi.kakao.com/v2/local/geo/coord2address.json?x=127.423084873712&y=37.0789561558879&input_coord=WGS84', headers=headers)
    return response.json()

# 위치 정보를 Redis에 저장하는 함수
def save_location_to_redis():
    user_location = get_user_location()
    location_data = {
        'latitude': user_location['y'],
        'longitude': user_location['x']
    }
    redis_client.set('location', json.dumps(location_data))

# 일정 시간 간격으로 위치 정보 업데이트
while True:
    save_location_to_redis()
    # 1초마다 업데이트
    time.sleep(1)

# 위치 정보를 Redis에서 가져오는 함수
def get_location_from_redis():
    location_data = redis_client.get('location')
    if location_data:
        return json.loads(location_data)
    else:
        return None

```

## 두 사용자의 위치르 받아서 거리 계산을 돌리자

```python
from geopy.distance import geodesic

# Redis 클라이언트 생성
redis_client = redis.Redis(host='localhost', port=6379, db=0)

# 위치 정보를 Redis에서 가져오는 함수
def get_location_from_redis(user_id):
    location_data = redis_client.get(user_id)
    if location_data:
        return json.loads(location_data)
    else:
        return None

# 두 유저 사이의 거리를 계산하는 함수
def get_distance(user1_id, user2_id):
    user1_location = get_location_from_redis(user1_id)
    user2_location = get_location_from_redis(user2_id)
    if user1_location and user2_location:
        user1_coordinates = (user1_location['latitude'], user1_location['longitude'])
        user2_coordinates = (user2_location['latitude'], user2_location['longitude'])
        distance = geodesic(user1_coordinates, user2_coordinates).km
        return distance
    else:
        return None

# 두 유저 사이의 거리를 출력하는 함수
def print_distance(user1_id, user2_id):
    distance = get_distance(user1_id, user2_id)
    if distance:
        print('The distance between User {} and User {} is {} kilometers.'.format(user1_id, user2_id, distance))
    else:
        print('Location data not found for both users.')

```