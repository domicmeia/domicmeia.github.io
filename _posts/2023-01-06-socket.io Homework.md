---
layout: post
category: Note
---
> `socket.io` Homework

기본코드는 socket.io - [Get started][soc] 참조

## Homework
Here are some ideas to improve the application:

- Broadcast a message to connected users when someone connects or disconnects.
- Add support for nicknames.
- Don’t send the same message to the user that sent it. Instead, append the message directly as soon as he/she - presses enter.
- Add “{user} is typing” functionality.
- Show who’s online.
- Add private messaging.
- Share your improvements!

## Broadcast a message to connected users when someone connects or disconnects

server side code만 바꾼다.
**index.js**
```js
io.on("connection", (socket) => {
  socket.emit('usercount', io.engine.clientsCount);
  socket.broadcast.emit('chat message', 'user connection...');
  socket.on('chat message', function (msg) {
    io.emit('chat message', msg);
  });
  socket.on('disconnect', function () {
    socket.broadcast.emit('chat message', 'user disconnection...');
  });
});
```

## Add support for nicknames

client side code만 바꾼다.
**index.html**
```js
<script>
  var socket = io()
  var messages = document.getElementById('messages');
  var form = document.getElementById('form');
  var input = document.getElementById('input');
  var username = prompt('please, enter a username: ', '')
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (input.value) {
      //socket.emit('chat message', input.value);
      addMessage(username+': '+ input.value);
      input.value = '';
    }
  })
  addMessage(username + ' is connected')
  function addMessage(msg) {
    var item = document.createElement('li');
    item.innerHTML = msg;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  }
</script>
```

1번과 2번 합친 버전
**client side code; index.html**
```js
<script>
  var socket = io();
  var messages = document.getElementById('messages');
  var form = document.getElementById('form');
  var input = document.getElementById('input');
  var username = prompt('please, enter a username: ', '')
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (input.value) {
      //socket.emit('chat message', input.value);
      addMessage(username+': '+ input.value);
      socket.emit('chat_message', {
        message: input.value
      });
      input.value = '';
    }
  })
  socket.on('chat_message', function(data) {
    addMessage(data.username + ': ' + data.message);
  })
  socket.on('user_join', function(data) {
    addMessage(data + ' just joined the chat!');
  })
  socket.on('user_leave', function(data) {
    addMessage(data + ' has left the chat.');
  })
  addMessage(username + ' is connected');
  socket.emit('user_join', username)
  function addMessage(msg) {
    var item = document.createElement('li');
    item.innerHTML = msg;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  }
</script>
```

**serve side code; index.js**
```js
const app = require('express')();
const http = require('http').Server(app);
const io = require('socket.io')(http);
const port = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.sendFile(__dirname + '/index.html');
});

//io.on('connection', (socket) => {
//  socket.on('chat message', msg => {
//    io.emit('chat message', msg);
//  });
//});

io.on('connection', function(socket) {
  socket.on('user_join', function(data) {
    this.username = data;
    socket.broadcast.emit('user_join', data);
  });

  socket.on('chat_message', function(data) {
    data.username = this.username;
    socket.broadcast.emit('chat_message', data);
  });

  socket.on('disconnect', function (data) {
    socket.broadcast.emit('user_leave', this.username
  });
});

http.listen(port, () => {
  console.log(`Socket.IO server running at http://localhost:${port}/`);
});
```

3번은 도대체 뭘까..

[soc]: https://socket.io/get-started/chat#homework
